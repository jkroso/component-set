#!/usr/bin/env node

var program = require('commander')
  , each = require('foreach/async')
  , utils = require('./utils')
  , log = require('./logger')
  , latest = utils.latest

log.enable('info')

program
	.usage('[options]')
	.description('update everything to their latest tag')
	.option('-d, --development', 'don\'t update production dependencies')
	.option('-p, --production', 'don\'t update development dependencies')

program.parse(process.argv)

var file = process.cwd() + '/component.json'

var json = utils.getDeps(file)

if (!program.development) update('dependencies').throw()
if (!program.production) update('development').throw()

function update(key){
	return each(json[key], function(tag, pkg){
		if (tag == '*') return
		var ur = pkg.split('/')
		return latest(ur[0], ur[1]).then(function(newtag){
			log.info(pkg, newtag)
			if (newtag != 'master' && newtag != tag) {
				utils.add(pkg, newtag, {
					file: file,
					development: key == 'development'
				})
			}
		})
	})
}
